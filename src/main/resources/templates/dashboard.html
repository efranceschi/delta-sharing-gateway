<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>
    <th:block th:replace="~{layout :: layout(~{::title}, ~{::content})}">
        <title>Dashboard</title>
        
        <th:block th:fragment="content">
            <!-- Breadcrumb -->
            <nav class="db-breadcrumb">
                <div class="db-breadcrumb-item">
                    <span class="db-breadcrumb-current"><i class="fas fa-home"></i> Home</span>
                </div>
            </nav>
            
            <!-- Top Bar -->
            <header class="db-topbar">
                <div class="db-topbar-left">
                    <h1 class="db-topbar-title">Dashboard</h1>
                </div>
            </header>
            
            <!-- Content -->
            <div class="db-content" style="background: #F9FAFB;">
                <!-- Statistics Cards - 4 Columns with Smaller Height -->
                <div style="padding: 24px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                    <!-- Shares Card -->
                    <div class="db-stat-card" style="padding: 12px 16px;">
                        <div class="db-stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3B82F6; width: 36px; height: 36px; font-size: 16px;">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="db-stat-content">
                            <div class="db-stat-label" style="font-size: 11px;">Shares</div>
                            <div class="db-stat-value" style="font-size: 22px;" th:text="${sharesCount ?: 0}">0</div>
                        </div>
                    </div>
                    
                    <!-- Schemas Card -->
                    <div class="db-stat-card" style="padding: 12px 16px;">
                        <div class="db-stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6; width: 36px; height: 36px; font-size: 16px;">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="db-stat-content">
                            <div class="db-stat-label" style="font-size: 11px;">Schemas</div>
                            <div class="db-stat-value" style="font-size: 22px;" th:text="${schemasCount ?: 0}">0</div>
                        </div>
                    </div>
                    
                    <!-- Tables Card -->
                    <div class="db-stat-card" style="padding: 12px 16px;">
                        <div class="db-stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10B981; width: 36px; height: 36px; font-size: 16px;">
                            <i class="fas fa-table"></i>
                        </div>
                        <div class="db-stat-content">
                            <div class="db-stat-label" style="font-size: 11px;">Tables</div>
                            <div class="db-stat-value" style="font-size: 22px;" th:text="${tablesCount ?: 0}">0</div>
                        </div>
                    </div>
                    
                    <!-- MinIO Buckets Card -->
                    <div class="db-stat-card" style="padding: 12px 16px;">
                        <div class="db-stat-icon" style="background: rgba(244, 114, 182, 0.1); color: #F472B6; width: 36px; height: 36px; font-size: 16px;">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="db-stat-content">
                            <div class="db-stat-label" style="font-size: 11px;">MinIO Buckets</div>
                            <div id="minio-buckets-stat" class="db-stat-value" style="font-size: 22px;">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Cache Efficiency & HTTP Timeline Row (1/3 + 2/3) -->
                <div style="padding: 0 24px 24px 24px; display: grid; grid-template-columns: 1fr 2fr; gap: 16px;">
                    
                    <!-- Cache Efficiency (1/3) -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1F2937;">
                            <i class="fas fa-database" style="margin-right: 8px; color: #10B981;"></i>
                            Cache Efficiency
                        </h3>
                        <div style="position: relative; height: 280px;">
                            <canvas id="cacheEfficiencyChart"></canvas>
                        </div>
                        <div id="cacheStats" style="margin-top: 16px; text-align: center;">
                            <div style="display: flex; justify-content: space-around; gap: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px;">Hit Rate</div>
                                    <div id="cacheHitRate" style="font-size: 24px; font-weight: 700; color: #10B981; margin-top: 4px;">--%</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
                                    <div id="cacheTotal" style="font-size: 24px; font-weight: 700; color: #1F2937; margin-top: 4px;">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- HTTP Timeline (2/3) -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px;">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1F2937;">
                            <i class="fas fa-chart-line" style="margin-right: 8px; color: #3B82F6;"></i>
                            HTTP Requests - Last Hour
                        </h3>
                        <div style="position: relative; height: 280px;">
                            <canvas id="requestTimelineChart"></canvas>
                        </div>
                    </div>
                    
                </div>
                
                <!-- HTTP Metrics Grid -->
                <div style="padding: 0 24px 24px 24px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    
                    <!-- Requests by Status (Pie Chart) -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #1F2937;">
                            <i class="fas fa-chart-pie" style="margin-right: 8px; color: #8B5CF6;"></i>
                            Requests by Status
                        </h4>
                        <div style="position: relative; height: 340px;">
                            <canvas id="statusPieChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top 10 Most Accessed URLs -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #1F2937;">
                            <i class="fas fa-fire" style="margin-right: 8px; color: #F59E0B;"></i>
                            Top 10 Most Accessed
                        </h4>
                        <div id="topUrlsList" style="min-height: 340px; font-size: 12px;">
                            <div style="text-align: center; padding: 40px; color: #9CA3AF;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                <div style="margin-top: 8px;">Loading...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top 10 Slowest URLs -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: #1F2937;">
                            <i class="fas fa-turtle" style="margin-right: 8px; color: #EF4444;"></i>
                            Top 10 Slowest
                        </h4>
                        <div id="slowestUrlsList" style="min-height: 340px; font-size: 12px;">
                            <div style="text-align: center; padding: 40px; color: #9CA3AF;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                <div style="margin-top: 8px;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- System Status Panel -->
                <div style="padding: 0 24px 24px 24px;">
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #1F2937;">
                            <i class="fas fa-heartbeat" style="margin-right: 8px; color: #EF4444;"></i>
                            System Status
                        </h3>
                        
                        <!-- Services Grid - 3 Columns Layout -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            
                            <!-- 1. JVM Memory -->
                            <div style="padding: 16px; background: #F9FAFB; border-radius: 6px; border-left: 4px solid #8B5CF6;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-weight: 600; color: #1F2937; font-size: 14px;">
                                            <i class="fas fa-memory" style="margin-right: 8px; color: #8B5CF6;"></i>
                                            JVM Memory
                                        </div>
                                        <div id="jvm-memory-text" style="font-size: 12px; color: #6B7280; margin-top: 4px;">Loading...</div>
                                    </div>
                                    <div id="jvm-status-badge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #F3F4F6; color: #6B7280;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                
                                <!-- Memory Progress Bar -->
                                <div style="margin-top: 8px;">
                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #6B7280; margin-bottom: 4px;">
                                        <span id="jvm-used">0 MB</span>
                                        <span id="jvm-max">0 MB</span>
                                    </div>
                                    <div style="width: 100%; height: 20px; background: #E5E7EB; border-radius: 10px; overflow: hidden; position: relative;">
                                        <div id="jvm-memory-bar" style="height: 100%; background: linear-gradient(90deg, #10B981, #059669); border-radius: 10px; width: 0%; transition: width 0.5s ease, background 0.5s ease;"></div>
                                        <div id="jvm-memory-percent" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 600; color: #1F2937;">0%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 2. Database Status -->
                            <div id="database-status-container" class="status-item" style="padding: 12px 16px; background: #F9FAFB; border-radius: 6px; border-left: 4px solid #9CA3AF;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div id="database-status-icon" style="width: 12px; height: 12px; border-radius: 50%; background: #9CA3AF;"></div>
                                        <div style="font-weight: 600; color: #1F2937; font-size: 14px;">
                                            <i class="fas fa-database" style="margin-right: 8px;"></i>
                                            Database
                                        </div>
                                    </div>
                                    <div id="database-status-badge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #F3F4F6; color: #6B7280;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div id="database-status-text" style="font-size: 12px; color: #6B7280;">Checking...</div>
                            </div>
                            
                            <!-- 3. MinIO Cluster -->
                            <div id="minio-cluster-container" class="status-item" style="padding: 12px 16px; background: #F9FAFB; border-radius: 6px; border-left: 4px solid #9CA3AF; display: none;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div id="minio-cluster-status-icon" style="width: 12px; height: 12px; border-radius: 50%; background: #9CA3AF;"></div>
                                        <div style="font-weight: 600; color: #1F2937; font-size: 14px;">
                                            <i class="fas fa-server" style="margin-right: 8px;"></i>
                                            MinIO Cluster
                                        </div>
                                    </div>
                                    <div id="minio-cluster-status-badge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #F3F4F6; color: #6B7280;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div id="minio-endpoint" style="font-size: 12px; color: #6B7280; word-break: break-all;">-</div>
                            </div>
                            
                            <!-- 4. MinIO Storage Status -->
                            <div id="minio-status-container" class="status-item" style="padding: 12px 16px; background: #F9FAFB; border-radius: 6px; border-left: 4px solid #9CA3AF;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div id="minio-status-icon" style="width: 12px; height: 12px; border-radius: 50%; background: #9CA3AF;"></div>
                                        <div style="font-weight: 600; color: #1F2937; font-size: 14px;">
                                            <i class="fas fa-hdd" style="margin-right: 8px;"></i>
                                            MinIO Storage
                                        </div>
                                    </div>
                                    <div id="minio-status-badge" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #F3F4F6; color: #6B7280;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                </div>
                                <div id="minio-status-text" style="font-size: 12px; color: #6B7280;">Checking...</div>
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Chart.js Library -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
            
            <!-- Custom Styles for Metrics -->
            <style>
                /* Tooltip hover effect for URL lists */
                .metric-item {
                    transition: transform 0.15s ease, box-shadow 0.15s ease;
                }
                .metric-item:hover {
                    transform: translateX(2px);
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
            </style>
            
            <!-- HTTP Metrics Script -->
            <script th:inline="javascript">
            (function() {
                // Chart instances
                let timelineChart = null;
                let statusPieChart = null;
                let cacheEfficiencyChart = null;
                
                // Initialize Cache Efficiency Chart
                function initCacheEfficiencyChart() {
                    const ctx = document.getElementById('cacheEfficiencyChart').getContext('2d');
                    cacheEfficiencyChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Cache Hits', 'Cache Misses'],
                            datasets: [{
                                data: [0, 0],
                                backgroundColor: [
                                    '#10B981', // Green for hits
                                    '#EF4444'  // Red for misses
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        padding: 10,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                            label += value.toLocaleString() + ' (' + percentage + '%)';
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Initialize Timeline Chart
                function initTimelineChart() {
                    const ctx = document.getElementById('requestTimelineChart').getContext('2d');
                    timelineChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Request Count',
                                    data: [],
                                    borderColor: '#3B82F6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Avg Response Time (ms)',
                                    data: [],
                                    borderColor: '#F59E0B',
                                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Request Count',
                                        color: '#3B82F6'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Response Time (ms)',
                                        color: '#F59E0B'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Initialize Status Pie Chart
                function initStatusPieChart() {
                    const ctx = document.getElementById('statusPieChart').getContext('2d');
                    statusPieChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: [
                                    '#10B981', // 2xx - Green
                                    '#3B82F6', // 3xx - Blue
                                    '#F59E0B', // 4xx - Yellow
                                    '#EF4444', // 5xx - Red
                                    '#8B5CF6'  // Other - Purple
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        padding: 10,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Load HTTP Metrics
                function loadHttpMetrics() {
                    fetch('/api/metrics/http')
                        .then(response => response.json())
                        .then(data => {
                            updateCacheChart(data.cache);
                            updateTimelineChart(data.timeline);
                            updateStatusPieChart(data.byStatus);
                            updateTopUrlsList(data.topUrls);
                            updateSlowestUrlsList(data.slowestUrls);
                        })
                        .catch(error => {
                            console.error('Error loading HTTP metrics:', error);
                        });
                }
                
                // Update Cache Efficiency Chart
                function updateCacheChart(cache) {
                    if (!cacheEfficiencyChart || !cache) return;
                    
                    const hits = cache.hits || 0;
                    const misses = cache.misses || 0;
                    const total = cache.total || 0;
                    const hitRate = cache.hitRate || 0;
                    
                    cacheEfficiencyChart.data.datasets[0].data = [hits, misses];
                    cacheEfficiencyChart.update();
                    
                    // Update stats
                    document.getElementById('cacheHitRate').textContent = hitRate.toFixed(1) + '%';
                    document.getElementById('cacheTotal').textContent = total.toLocaleString();
                    
                    // Update hit rate color based on performance
                    const hitRateElement = document.getElementById('cacheHitRate');
                    if (hitRate >= 80) {
                        hitRateElement.style.color = '#10B981'; // Green
                    } else if (hitRate >= 50) {
                        hitRateElement.style.color = '#F59E0B'; // Yellow
                    } else {
                        hitRateElement.style.color = '#EF4444'; // Red
                    }
                }
                
                // Update Timeline Chart
                function updateTimelineChart(timeline) {
                    if (!timelineChart || !timeline) return;
                    
                    const labels = timeline.timestamps.map(ts => {
                        const date = new Date(ts);
                        return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    });
                    
                    timelineChart.data.labels = labels;
                    timelineChart.data.datasets[0].data = timeline.counts;
                    timelineChart.data.datasets[1].data = timeline.avgTimes;
                    timelineChart.update();
                }
                
                // Update Status Pie Chart
                function updateStatusPieChart(byStatus) {
                    if (!statusPieChart || !byStatus) return;
                    
                    const labels = Object.keys(byStatus);
                    const data = Object.values(byStatus);
                    
                    statusPieChart.data.labels = labels;
                    statusPieChart.data.datasets[0].data = data;
                    statusPieChart.update();
                }
                
                // Helper function to truncate URI
                function truncateUri(uri, maxLength = 35) {
                    if (uri.length <= maxLength) return uri;
                    return uri.substring(0, maxLength) + '...';
                }
                
                // Update Top URLs List
                function updateTopUrlsList(topUrls) {
                    const container = document.getElementById('topUrlsList');
                    if (!container || !topUrls || topUrls.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9CA3AF;">No data available</div>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 4px;">';
                    
                    topUrls.forEach((url, index) => {
                        const avgTime = url.avgTime.toFixed(1);
                        const truncatedUri = truncateUri(url.uri);
                        html += `
                            <div class="metric-item" title="${url.uri}" style="padding: 6px 8px; background: #F9FAFB; border-radius: 3px; border-left: 2px solid #3B82F6; cursor: help; display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                                    <span style="font-weight: 600; color: #6B7280; font-size: 9px; flex-shrink: 0;">#${index + 1}</span>
                                    <span style="color: #4B5563; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${truncatedUri}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                                    <span style="font-weight: 600; color: #3B82F6; font-size: 10px;">${url.count}</span>
                                    <span style="color: #9CA3AF; font-size: 9px;">·</span>
                                    <span style="color: #6B7280; font-size: 9px;">${avgTime}ms</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                }
                
                // Update Slowest URLs List
                function updateSlowestUrlsList(slowestUrls) {
                    const container = document.getElementById('slowestUrlsList');
                    if (!container || !slowestUrls || slowestUrls.length === 0) {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9CA3AF;">No data available</div>';
                        return;
                    }
                    
                    let html = '<div style="display: flex; flex-direction: column; gap: 4px;">';
                    
                    slowestUrls.forEach((url, index) => {
                        const avgTime = url.avgTime.toFixed(1);
                        const truncatedUri = truncateUri(url.uri);
                        
                        // Intensidade de cor baseada no ranking (mais vermelho para os primeiros)
                        const redIntensity = Math.max(239 - (index * 15), 200);
                        const borderColor = `rgb(${redIntensity}, 68, 68)`;
                        const bgColor = index < 3 ? '#FEF2F2' : '#FEF9F9';
                        
                        html += `
                            <div class="metric-item" title="${url.uri}" style="padding: 6px 8px; background: ${bgColor}; border-radius: 3px; border-left: 2px solid ${borderColor}; cursor: help; display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                                    <span style="font-weight: 600; color: #6B7280; font-size: 9px; flex-shrink: 0;">#${index + 1}</span>
                                    <span style="color: #4B5563; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${truncatedUri}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                                    <span style="font-weight: 600; color: #EF4444; font-size: 10px;">${avgTime}ms</span>
                                    <span style="color: #9CA3AF; font-size: 9px;">·</span>
                                    <span style="color: #6B7280; font-size: 9px;">${url.count}×</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    container.innerHTML = html;
                }
                
                // Initialize charts
                initCacheEfficiencyChart();
                initTimelineChart();
                initStatusPieChart();
                
                // Initial load
                loadHttpMetrics();
                
                // Refresh every 10 seconds
                setInterval(loadHttpMetrics, 10000);
            })();
            </script>
            
            <!-- Status Check Script -->
            <script th:inline="javascript">
            (function() {
                // Status colors configuration
                const statusConfig = {
                    'healthy': { color: '#10B981', borderColor: '#10B981', bgColor: '#ECFDF5', badgeText: 'Healthy', badgeBg: '#D1FAE5', badgeColor: '#065F46', icon: 'fa-check-circle' },
                    'unhealthy': { color: '#EF4444', borderColor: '#EF4444', bgColor: '#FEF2F2', badgeText: 'Unhealthy', badgeBg: '#FEE2E2', badgeColor: '#991B1B', icon: 'fa-exclamation-circle' },
                    'warning': { color: '#F59E0B', borderColor: '#F59E0B', bgColor: '#FFFBEB', badgeText: 'Warning', badgeBg: '#FEF3C7', badgeColor: '#92400E', icon: 'fa-exclamation-triangle' },
                    'critical': { color: '#DC2626', borderColor: '#DC2626', bgColor: '#FEF2F2', badgeText: 'Critical', badgeBg: '#FEE2E2', badgeColor: '#7F1D1D', icon: 'fa-exclamation-triangle' },
                    'unavailable': { color: '#F59E0B', borderColor: '#F59E0B', bgColor: '#FFFBEB', badgeText: 'Unavailable', badgeBg: '#FEF3C7', badgeColor: '#92400E', icon: 'fa-minus-circle' },
                    'disabled': { color: '#6B7280', borderColor: '#9CA3AF', bgColor: '#F9FAFB', badgeText: 'Disabled', badgeBg: '#F3F4F6', badgeColor: '#374151', icon: 'fa-power-off' },
                    'error': { color: '#DC2626', borderColor: '#DC2626', bgColor: '#FEF2F2', badgeText: 'Error', badgeBg: '#FEE2E2', badgeColor: '#7F1D1D', icon: 'fa-times-circle' }
                };
                
                // Helper function to format bytes
                function formatBytes(bytes) {
                    const mb = bytes / (1024 * 1024);
                    if (mb >= 1024) {
                        return (mb / 1024).toFixed(2) + ' GB';
                    }
                    return mb.toFixed(0) + ' MB';
                }
                
                // Update service status (generic)
                function updateServiceStatus(serviceId, data) {
                    const container = document.getElementById(`${serviceId}-status-container`);
                    const icon = document.getElementById(`${serviceId}-status-icon`);
                    const text = document.getElementById(`${serviceId}-status-text`);
                    const badge = document.getElementById(`${serviceId}-status-badge`);
                    
                    if (!container || !icon || !text || !badge) return;
                    
                    const config = statusConfig[data.status] || statusConfig['error'];
                    
                    icon.style.background = config.color;
                    container.style.background = config.bgColor;
                    container.style.borderLeftColor = config.borderColor;
                    text.textContent = data.message || 'Unknown status';
                    badge.innerHTML = '<i class="fas ' + config.icon + '"></i> ' + config.badgeText;
                    badge.style.background = config.badgeBg;
                    badge.style.color = config.badgeColor;
                }
                
                // Check Database status
                function checkDatabaseStatus() {
                    fetch('/api/health/database')
                        .then(response => response.json())
                        .then(data => {
                            updateServiceStatus('database', data);
                            
                            // Update detailed info
                            const text = document.getElementById('database-status-text');
                            if (data.product && data.version) {
                                text.textContent = `${data.product} ${data.version}`;
                            }
                        })
                        .catch(error => {
                            console.error('Error checking database status:', error);
                            updateServiceStatus('database', { status: 'error', message: 'Failed to check status' });
                        });
                }
                
                // Check MinIO status
                function checkMinioStatus() {
                    fetch('/api/health/minio')
                        .then(response => response.json())
                        .then(data => {
                            updateServiceStatus('minio', data);
                        })
                        .catch(error => {
                            console.error('Error checking MinIO status:', error);
                            updateServiceStatus('minio', { status: 'error', message: 'Failed to check status' });
                        });
                }
                
                // Check JVM Memory
                function checkJVMMemory() {
                    fetch('/api/health/jvm')
                        .then(response => response.json())
                        .then(data => {
                            const memory = data.memory;
                            const usagePercent = memory.maxUsagePercent;
                            
                            // Update text
                            document.getElementById('jvm-memory-text').textContent = 
                                `${formatBytes(memory.used)} used / ${formatBytes(memory.max)} max (${memory.processors} CPUs)`;
                            
                            // Update values
                            document.getElementById('jvm-used').textContent = formatBytes(memory.used);
                            document.getElementById('jvm-max').textContent = formatBytes(memory.max);
                            document.getElementById('jvm-memory-percent').textContent = usagePercent.toFixed(1) + '%';
                            
                            // Update progress bar
                            const bar = document.getElementById('jvm-memory-bar');
                            bar.style.width = usagePercent + '%';
                            
                            // Change color based on usage
                            if (usagePercent > 90) {
                                bar.style.background = 'linear-gradient(90deg, #DC2626, #991B1B)';
                            } else if (usagePercent > 75) {
                                bar.style.background = 'linear-gradient(90deg, #F59E0B, #D97706)';
                            } else {
                                bar.style.background = 'linear-gradient(90deg, #10B981, #059669)';
                            }
                            
                            // Update badge
                            const badge = document.getElementById('jvm-status-badge');
                            const config = statusConfig[data.status] || statusConfig['healthy'];
                            badge.innerHTML = '<i class="fas ' + config.icon + '"></i> ' + config.badgeText;
                            badge.style.background = config.badgeBg;
                            badge.style.color = config.badgeColor;
                        })
                        .catch(error => {
                            console.error('Error checking JVM memory:', error);
                            document.getElementById('jvm-memory-text').textContent = 'Failed to retrieve memory info';
                        });
                }
                
                // Check MinIO Cluster Info
                function checkMinIOCluster() {
                    fetch('/api/health/minio/cluster')
                        .then(response => response.json())
                        .then(data => {
                            const container = document.getElementById('minio-cluster-container');
                            const icon = document.getElementById('minio-cluster-status-icon');
                            const badge = document.getElementById('minio-cluster-status-badge');
                            const endpointDiv = document.getElementById('minio-endpoint');
                            const bucketsStatDiv = document.getElementById('minio-buckets-stat');
                            
                            if (data.status === 'disabled') {
                                container.style.display = 'none';
                                if (bucketsStatDiv) bucketsStatDiv.textContent = '-';
                                return;
                            }
                            
                            container.style.display = 'block';
                            
                            if (data.info && data.info.bucketCount !== undefined) {
                                // Update buckets count in the stat card (first row)
                                if (bucketsStatDiv) {
                                    bucketsStatDiv.textContent = data.info.bucketCount;
                                }
                                
                                // Update endpoint
                                if (data.info.endpoint && endpointDiv) {
                                    endpointDiv.textContent = data.info.endpoint;
                                }
                                
                                // Determine status: if admin is operational or cluster is available, show Healthy
                                let clusterStatus = 'healthy';
                                if (data.info.adminStatus === 'error' || !data.info.available) {
                                    clusterStatus = 'warning';
                                }
                                
                                const config = statusConfig[clusterStatus];
                                
                                // Update visual elements
                                if (icon) icon.style.background = config.color;
                                if (container) {
                                    container.style.background = config.bgColor;
                                    container.style.borderLeftColor = config.borderColor;
                                }
                                if (badge) {
                                    badge.innerHTML = '<i class="fas ' + config.icon + '"></i> ' + config.badgeText;
                                    badge.style.background = config.badgeBg;
                                    badge.style.color = config.badgeColor;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error checking MinIO cluster:', error);
                            const bucketsStatDiv = document.getElementById('minio-buckets-stat');
                            if (bucketsStatDiv) bucketsStatDiv.textContent = '-';
                        });
                }
                
                // Initialize all checks
                function checkAllStatus() {
                    checkDatabaseStatus();
                    checkMinioStatus();
                    checkJVMMemory();
                    checkMinIOCluster();
                }
                
                // Initial check
                checkAllStatus();
                
                // Periodic refresh (60 seconds for most, 10 seconds for JVM)
                setInterval(function() {
                    checkDatabaseStatus();
                    checkMinioStatus();
                    checkMinIOCluster();
                }, 60000);
                
                setInterval(checkJVMMemory, 10000);
            })();
            </script>
        </th:block>
    </th:block>
</body>
</html>
