<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
</head>
<body>
    <th:block th:replace="~{layout :: layout(~{::title}, ~{::content})}">
        <title>Users</title>
        
        <th:block th:fragment="content">
            <!-- Breadcrumb -->
            <nav class="db-breadcrumb">
                <div class="db-breadcrumb-item">
                    <a href="/"><i class="fas fa-home"></i> Home</a>
                </div>
                <span class="db-breadcrumb-separator">›</span>
                <div class="db-breadcrumb-item">
                    <span class="db-breadcrumb-current">Users</span>
                </div>
            </nav>
            
            <!-- Top Bar -->
            <header class="db-topbar">
                <div class="db-topbar-left">
                    <h1 class="db-topbar-title">Users</h1>
                </div>
                <div class="db-topbar-actions" sec:authorize="hasRole('ADMIN')">
                    <button class="db-btn db-btn-primary" onclick="window.location.href='/system/users/new'">
                        + Create user
                    </button>
                </div>
            </header>
            
            <!-- Content -->
            <div class="db-content" style="background: #F9FAFB;">
                <!-- Alerts -->
                <div th:if="${successMessage != null or errorMessage != null}" style="padding: 16px 24px;">
                    <div th:if="${successMessage != null}" class="db-alert db-alert-success">
                        <i class="fas fa-check-circle"></i>
                        <span th:text="${successMessage}">Success</span>
                    </div>
                    <div th:if="${errorMessage != null}" class="db-alert db-alert-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span th:text="${errorMessage}">Error</span>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="db-content-header">
                    <input type="text" class="db-filter-input" placeholder="Filter users..." id="userFilter">
                </div>
                
                <!-- Table -->
                <div class="db-table-wrapper">
                    <table class="db-table" id="usersTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th style="width: 100px;">Enabled</th>
                                <th style="width: 100px;">Active</th>
                                <th style="width: 120px;">Token Status</th>
                                <th style="width: 60px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}">
                                <td th:text="${user.id}">1</td>
                                <td>
                                    <a th:href="@{/system/users/{id}/edit(id=${user.id})}" 
                                       th:text="${user.username}"
                                       style="color: var(--db-primary); text-decoration: none; font-weight: 500;">admin</a>
                                </td>
                                <td th:text="${user.fullName ?: '-'}">Admin User</td>
                                <td th:text="${user.email ?: '-'}">admin@example.com</td>
                                <td>
                                    <span class="db-badge-status" 
                                          th:classappend="${user.role == 'ADMIN' ? 'db-badge-danger' : 'db-badge-info'}"
                                          th:text="${user.role}">USER</span>
                                </td>
                                <td>
                                    <span th:if="${user.enabled}" class="db-badge-status db-badge-success">
                                        <i class="fas fa-check"></i> Yes
                                    </span>
                                    <span th:if="${!user.enabled}" class="db-badge-status db-badge-danger">
                                        <i class="fas fa-times"></i> No
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${user.active}" class="db-badge-status db-badge-success">
                                        <i class="fas fa-check"></i> Yes
                                    </span>
                                    <span th:if="${!user.active}" class="db-badge-status db-badge-danger">
                                        <i class="fas fa-times"></i> No
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${user.apiToken != null}" class="db-badge-status db-badge-success">
                                        <i class="fas fa-key"></i> Active
                                    </span>
                                    <span th:if="${user.apiToken == null}" class="db-badge-status db-badge-secondary">
                                        <i class="fas fa-ban"></i> None
                                    </span>
                                </td>
                                <td>
                                    <div class="db-actions-menu">
                                        <button class="db-actions-trigger">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="db-actions-dropdown">
                                            <a class="db-action-item" th:data-href="@{/system/users/{id}/edit(id=${user.id})}" onclick="window.location.href=this.dataset.href">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                            <div class="db-action-separator"></div>
                                            <!-- Token Management -->
                                            <button class="db-action-item" 
                                                    th:if="${user.apiToken == null and user.active}"
                                                    onclick="generateToken(this)"
                                                    th:data-user-id="${user.id}"
                                                    th:data-username="${user.username}">
                                                <i class="fas fa-key"></i> Generate Token
                                            </button>
                                            <button class="db-action-item" 
                                                    th:if="${user.apiToken != null and user.active}"
                                                    onclick="regenerateToken(this)"
                                                    th:data-user-id="${user.id}"
                                                    th:data-username="${user.username}">
                                                <i class="fas fa-sync"></i> Regenerate Token
                                            </button>
                                            <button class="db-action-item db-action-danger" 
                                                    th:if="${user.apiToken != null}"
                                                    onclick="revokeToken(this)"
                                                    th:data-href="@{/system/users/{id}/revoke-token(id=${user.id})}"
                                                    th:data-username="${user.username}">
                                                <i class="fas fa-ban"></i> Revoke Token
                                            </button>
                                            <button class="db-action-item" 
                                                    th:if="${user.apiToken != null and user.active}"
                                                    th:data-href="@{/system/users/{id}/download-credentials(id=${user.id})}" 
                                                    onclick="window.location.href=this.dataset.href">
                                                <i class="fas fa-download"></i> Download Credentials
                                            </button>
                                            <div class="db-action-separator"></div>
                                            <button class="db-action-item db-action-danger" 
                                                    onclick="confirmDelete(this)" 
                                                    th:data-href="@{/system/users/{id}/delete(id=${user.id})}"
                                                    th:data-name="${user.username}">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <script>
                // Filter functionality
                const filterInput = document.getElementById('userFilter');
                const table = document.getElementById('usersTable');
                const rows = table.querySelectorAll('tbody tr');
                
                filterInput.addEventListener('input', function() {
                    const filterValue = this.value.toLowerCase();
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(filterValue) ? '' : 'none';
                    });
                });
                
                // Delete confirmation
                function confirmDelete(element) {
                    const name = element.dataset.name;
                    const href = element.dataset.href;
                    
                    if (confirm('Are you sure you want to delete user "' + name + '"?')) {
                        window.location.href = href;
                    }
                }
                
                // Token Management Functions
                function generateToken(element) {
                    const userId = element.dataset.userId;
                    const username = element.dataset.username;
                    
                    if (!confirm('Generate a new API token for user "' + username + '"?')) {
                        return;
                    }
                    
                    // Close dropdown
                    document.querySelectorAll('.db-actions-dropdown.show').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                    
                    performTokenGeneration(userId, username);
                }
                
                function regenerateToken(element) {
                    const userId = element.dataset.userId;
                    const username = element.dataset.username;
                    
                    if (!confirm('Regenerate API token for user "' + username + '"?\n\nThe old token will be invalidated.')) {
                        return;
                    }
                    
                    // Close dropdown
                    document.querySelectorAll('.db-actions-dropdown.show').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                    
                    performTokenGeneration(userId, username);
                }
                
                function performTokenGeneration(userId, username) {
                    // Get CSRF token from meta tag
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
                    
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (csrfToken && csrfHeader) {
                        headers[csrfHeader] = csrfToken;
                    }
                    
                    fetch('/system/users/' + userId + '/generate-token', {
                        method: 'POST',
                        headers: headers
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { 
                                throw new Error(text || 'Failed to generate token') 
                            });
                        }
                        return response.text();
                    })
                    .then(token => {
                        alert('Token generated successfully for user "' + username + '"\n\nToken: ' + token + '\n\nLength: ' + token.length + ' characters\n\n⚠️ This is the only time you will see this token. Make sure to save it!');
                        window.location.reload();
                    })
                    .catch(error => {
                        alert('Error generating token: ' + error.message);
                    });
                }
                
                function revokeToken(element) {
                    const href = element.dataset.href;
                    const username = element.dataset.username;
                    
                    if (!confirm('Are you sure you want to revoke the API token for user "' + username + '"?\n\nThis action cannot be undone.')) {
                        return;
                    }
                    
                    // Close dropdown
                    document.querySelectorAll('.db-actions-dropdown.show').forEach(dropdown => {
                        dropdown.classList.remove('show');
                    });
                    
                    window.location.href = href;
                }
            </script>
        </th:block>
    </th:block>
</body>
</html>

